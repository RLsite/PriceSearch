{% extends "base.html" %}

{% block title %}×ª×•×¦××•×ª ×¢×‘×•×¨: {{ query }} | PriceHunter{% endblock %}

{% block content %}
<!-- Search Header -->
<section class="search-header">
    <div class="search-info-card">
        <div class="search-navigation">
            <a href="{{ url_for('home') }}" class="back-button">
                â† ×—×–×¨×” ×œ×¢××•×“ ×”×‘×™×ª
            </a>
        </div>
        
        <h2 class="search-title">×ª×•×¦××•×ª ×¢×‘×•×¨: "{{ query }}"</h2>
        
        <div class="search-stats">
            {% if has_results %}
                <p class="results-summary">
                    <span class="highlight">{{ results.total_products }}</span> ××•×¦×¨×™× × ××¦××•
                    ×‘-<span class="highlight">{{ "%.2f"|format(search_time) }}</span> ×©× ×™×•×ª
                    ××ª×•×š <span class="highlight">{{ stores_count }}</span> ×—× ×•×™×•×ª
                </p>
                
                {% if results.errors %}
                <div class="search-warnings">
                    <span class="warning-icon">âš ï¸</span>
                    <span>×‘×¢×™×•×ª ×‘×—×œ×§ ××”×—× ×•×™×•×ª ({{ results.errors|length }})</span>
                    <details class="error-details">
                        <summary>×¤×¨×˜×™×</summary>
                        <ul>
                            {% for error in results.errors %}
                            <li>{{ error }}</li>
                            {% endfor %}
                        </ul>
                    </details>
                </div>
                {% endif %}
            {% else %}
                <p class="no-results-summary">
                    ×œ× × ××¦××• ×ª×•×¦××•×ª ×‘-<span class="highlight">{{ "%.2f"|format(search_time) }}</span> ×©× ×™×•×ª
                    ××ª×•×š {{ stores_count }} ×—× ×•×™×•×ª
                </p>
            {% endif %}
        </div>

        <!-- New Search Form -->
        <form class="inline-search-form" action="{{ url_for('search') }}" method="get">
            <div class="inline-search-group">
                <input 
                    type="text" 
                    name="q" 
                    class="inline-search-input"
                    value="{{ query }}"
                    placeholder="×—×™×¤×•×© ×—×“×©..."
                >
                <button type="submit" class="inline-search-button">ğŸ”</button>
            </div>
        </form>
    </div>
</section>

{% if has_results %}
<!-- Best Deal Alert -->
{% if results.best_deal and results.best_deal.savings %}
<section class="best-deal-section">
    <div class="best-deal-alert">
        <div class="best-deal-icon">ğŸ†</div>
        <div class="best-deal-content">
            <h3>×¢×¡×§×” ××¢×•×œ×” × ××¦××”!</h3>
            <p>
                ×”××—×™×¨ ×”×˜×•×‘ ×‘×™×•×ª×¨ ×‘-{{ results.best_deal.store }}:
                <strong>â‚ª{{ "%.0f"|format(results.best_deal.price) }}</strong>
            </p>
            <p class="savings-info">
                ×—×•×¡×š ×œ×š <strong>â‚ª{{ "%.0f"|format(results.best_deal.savings) }}</strong>
                ({{ results.best_deal.savings_percent }}% ××”××—×™×¨ ×”×’×‘×•×” ×‘×™×•×ª×¨)
            </p>
        </div>
    </div>
</section>
{% endif %}

<!-- Products Results -->
<section class="products-section">
    <div class="products-container">
        {% for product in results.products %}
        <div class="product-card {% if loop.first and results.best_deal %}best-deal{% endif %}">
            {% if loop.first and results.best_deal %}
            <div class="best-deal-badge">ğŸ† ×”××—×™×¨ ×”×˜×•×‘ ×‘×™×•×ª×¨</div>
            {% endif %}
            
            <div class="product-content">
                <!-- Product Image -->
                <div class="product-image">
                    {% if product.image_url %}
                    <img src="{{ product.image_url }}" alt="{{ product.name }}" loading="lazy">
                    {% else %}
                    <div class="placeholder-image">
                        <span class="image-icon">ğŸ“±</span>
                    </div>
                    {% endif %}
                </div>
                
                <!-- Product Details -->
                <div class="product-details">
                    <h3 class="product-name">{{ product.name }}</h3>
                    
                    <div class="store-info">
                        <div class="store-badge">
                            <span class="store-logo">{{ product.store_logo }}</span>
                            <span class="store-name">{{ product.store }}</span>
                        </div>
                        
                        <div class="availability-badge availability-{{ product.availability|lower|replace(' ', '-') }}">
                            {% if product.availability == "×–××™×Ÿ" %}
                            âœ… ×–××™×Ÿ
                            {% elif "××–×œ" in product.availability %}
                            âŒ ××–×œ ××”××œ××™
                            {% elif "×”×–×× ×”" in product.availability %}
                            ğŸ“¦ ×”×–×× ×” ××¨××©
                            {% else %}
                            â„¹ï¸ {{ product.availability }}
                            {% endif %}
                        </div>
                    </div>
                    
                    <div class="price-section">
                        <div class="current-price">â‚ª{{ "%.0f"|format(product.price) }}</div>
                        
                        {% if results.best_deal and product.price > results.best_deal.price %}
                        <div class="price-difference">
                            +â‚ª{{ "%.0f"|format(product.price - results.best_deal.price) }}
                            ××”××—×™×¨ ×”×˜×•×‘ ×‘×™×•×ª×¨
                        </div>
                        {% endif %}
                    </div>
                </div>
                
                <!-- Product Actions -->
                <div class="product-actions">
                    {% if product.url %}
                    <a href="{{ product.url }}" 
                       target="_blank" 
                       rel="noopener noreferrer"
                       class="btn btn-primary buy-button">
                        ğŸ›’ ×§× ×” ×¢×›×©×™×•
                    </a>
                    {% endif %}
                    
                    <button class="btn btn-secondary share-button"
                            onclick="shareProduct('{{ product.name }}', {{ product.price }}, '{{ product.store }}')">
                        ğŸ“¤ ×©×ª×£
                    </button>
                </div>
            </div>
            
            <!-- Product Meta -->
            <div class="product-meta">
                <small class="last-updated">
                    ×¢×•×“×›×Ÿ ×œ××—×¨×•× ×”: {{ moment(product.last_updated).fromNow() if product.last_updated else "×–×” ×¢×ª×”" }}
                </small>
            </div>
        </div>
        {% endfor %}
    </div>
</section>

{% else %}
<!-- No Results -->
<section class="no-results-section">
    <div class="no-results-card">
        <div class="no-results-icon">ğŸ”</div>
        <h3 class="no-results-title">×œ× × ××¦××• ×ª×•×¦××•×ª ×¢×‘×•×¨ "{{ query }}"</h3>
        <p class="no-results-message">× ×¡×” ××™×œ×•×ª ×—×™×¤×•×© ××—×¨×•×ª ××• ×¤×©×•×˜×•×ª ×™×•×ª×¨</p>
        
        <div class="search-suggestions">
            <h4>ğŸ’¡ ×˜×™×¤×™× ×œ×—×™×¤×•×© ×˜×•×‘ ×™×•×ª×¨:</h4>
            <ul class="suggestions-list">
                <li>× ×¡×” ×¨×§ ××ª ×©× ×”××•×¦×¨: "iPhone" ×‘××§×•× "iPhone 15 Pro Max"</li>
                <li>×”×©×ª××© ×‘××™×œ×™× ×‘×× ×’×œ×™×ª: "MacBook" ×‘××§×•× "××§×‘×•×§"</li>
                <li>×‘×“×•×§ ××ª ×”×›×ª×™×‘ - ××•×œ×™ ×™×© ×˜×¢×•×ª ×§×˜× ×”</li>
                <li>× ×¡×” ××™×œ×™× ×›×œ×œ×™×•×ª ×™×•×ª×¨: "××•×–× ×™×•×ª" ×‘××§×•× "AirPods Pro Max"</li>
            </ul>
        </div>
        
        <div class="suggested-searches">
            <h4>×—×™×¤×•×©×™× ×¤×•×¤×•×œ×¨×™×™×:</h4>
            <div class="suggestion-tags">
                <a href="{{ url_for('search', q='iPhone') }}" class="suggestion-tag">iPhone</a>
                <a href="{{ url_for('search', q='MacBook') }}" class="suggestion-tag">MacBook</a>
                <a href="{{ url_for('search', q='××•×–× ×™×•×ª') }}" class="suggestion-tag">××•×–× ×™×•×ª</a>
                <a href="{{ url_for('search', q='××—×©×‘ × ×™×™×“') }}" class="suggestion-tag">××—×©×‘ × ×™×™×“</a>
            </div>
        </div>
    </div>
</section>
{% endif %}

<!-- Related Searches -->
{% if has_results %}
<section class="related-searches-section">
    <div class="related-searches-card">
        <h4>×—×™×¤×•×©×™× ×§×©×•×¨×™×:</h4>
        <div class="related-tags">
            <!-- × ×•×›×œ ×œ×”×•×¡×™×£ ×œ×•×’×™×§×” ×œ×—×™×¤×•×©×™× ×§×©×•×¨×™× -->
            <a href="{{ url_for('search', q=query + ' reviews') }}" class="related-tag">{{ query }} ×‘×™×§×•×¨×•×ª</a>
            <a href="{{ url_for('search', q=query + ' ××—×™×¨') }}" class="related-tag">{{ query }} ××—×™×¨</a>
            <a href="{{ url_for('search', q=query + ' ×–×•×œ') }}" class="related-tag">{{ query }} ×–×•×œ</a>
        </div>
    </div>
</section>
{% endif %}
{% endblock %}

{% block extra_js %}
<script>
// JavaScript ×œ×“×£ ×ª×•×¦××•×ª
document.addEventListener('DOMContentLoaded', function() {
    // ×”×•×¡×¤×ª ×× ×™××¦×™×•×ª ×œ×›×¨×˜×™×¡×™ ××•×¦×¨×™×
    animateProductCards();
    
    // ××¢×§×‘ ×¢×œ ×œ×—×™×¦×•×ª ×¢×œ ×›×¤×ª×•×¨×™ ×§× ×™×™×”
    trackPurchaseClicks();
    
    // ×¢×“×›×•×Ÿ ×–×× ×™ ×¢×“×›×•×Ÿ
    updateTimestamps();
});

function animateProductCards() {
    const cards = document.querySelectorAll('.product-card');
    cards.forEach((card, index) => {
        card.style.opacity = '0';
        card.style.transform = 'translateY(20px)';
        
        setTimeout(() => {
            card.style.transition = 'opacity 0.5s ease, transform 0.5s ease';
            card.style.opacity = '1';
            card.style.transform = 'translateY(0)';
        }, index * 100);
    });
}

function trackPurchaseClicks() {
    const buyButtons = document.querySelectorAll('.buy-button');
    buyButtons.forEach(button => {
        button.addEventListener('click', function(e) {
            // ×™×›×•×œ ×œ×”×•×¡×™×£ Google Analytics ××• ××¢×§×‘ ××—×¨
            console.log('Purchase click tracked:', this.href);
        });
    });
}

function shareProduct(name, price, store) {
    const text = `××¦××ª×™ ××ª ${name} ×‘-${store} ×‘××—×™×¨ â‚ª${price.toLocaleString('he-IL')}`;
    const url = window.location.href;
    
    if (navigator.share) {
        navigator.share({
            title: 'PriceHunter - ××—×™×¨ ××¢×•×œ×”!',
            text: text,
            url: url
        }).catch(console.error);
    } else {
        // Fallback - copy to clipboard
        copyToClipboard(`${text}\n${url}`);
        showNotification('×”×§×™×©×•×¨ ×”×•×¢×ª×§!', 'success');
    }
}

function copyToClipboard(text) {
    navigator.clipboard.writeText(text).catch(() => {
        // Fallback for older browsers
        const textArea = document.createElement('textarea');
        textArea.value = text;
        textArea.style.position = 'fixed';
        textArea.style.opacity = '0';
        document.body.appendChild(textArea);
        textArea.select();
        document.execCommand('copy');
        document.body.removeChild(textArea);
    });
}

function showNotification(message, type = 'info') {
    // ×™×›×•×œ ×œ×”×©×ª××© ×‘-toast notifications
    alert(message); // ×–×× ×™×ª
}

function updateTimestamps() {
    // ×¢×“×›×•×Ÿ ×–×× ×™ "×¢×•×“×›×Ÿ ×œ××—×¨×•× ×”" ×›×œ ×“×§×”
    setInterval(() => {
        const timestamps = document.querySelectorAll('.last-updated');
        timestamps.forEach(elem => {
            // ×œ×•×’×™×§×” ×œ×¢×“×›×•×Ÿ ×–×× ×™×
        });
    }, 60000);
}
</script>
{% endblock %}
